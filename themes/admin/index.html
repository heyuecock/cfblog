<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{{OPT.siteName}} 博客后台</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="{{OPT.logo}}">
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'PingFang SC','Microsoft YaHei',Arial,sans-serif; }
    .navbar { border-radius: 0; margin-bottom: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);}
    .navbar-brand { font-weight: bold; color: #007aff !important; }
    .sidebar { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 0; }
    .sidebar .nav > li > a { color: #333; font-size: 16px; border-radius: 0 20px 20px 0; }
    .sidebar .nav > li.active > a, .sidebar .nav > li > a:hover { background: #f0f4fa; color: #007aff; }
    .main-panel { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 32px 28px; min-height: 600px;}
    .panel-title { font-size: 22px; font-weight: 700; color: #007aff; margin-bottom: 24px; }
    .btn-primary { background: #007aff; border-color: #007aff; }
    .btn-primary:hover { background: #005ecb; border-color: #005ecb; }
    .table > thead > tr > th { color: #007aff; background: #f7f8fa; }
    .table > tbody > tr:hover { background: #f0f4fa; }
    .form-control:focus { border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.08);}
    .tab-content > .tab-pane { margin-top: 18px; }
    .import-export-btns { margin-bottom: 18px; }
    .tag-list, .cat-list, .menu-list, .link-list { margin: 0; padding: 0; list-style: none; }
    .tag-list li, .cat-list li, .menu-list li, .link-list li { display: inline-block; margin: 0 8px 8px 0; background: #f0f4fa; border-radius: 6px; padding: 4px 10px; }
    .setting-section { margin-bottom: 32px; }
    .setting-section h4 { color: #007aff; margin-bottom: 12px; }
    .publish-section { margin-bottom: 32px; }
    @media (max-width: 900px) {
      .sidebar { margin-bottom: 18px; }
      .main-panel { padding: 18px 8px; }
    }
  </style>
</head>
<body>
  <!-- 顶部导航 -->
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="/"><img src="{{OPT.logo}}" style="height:32px;display:inline;margin-right:8px;border-radius:8px;">{{OPT.siteName}}</a>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/" target="_blank">博客首页</a></li>
        <li class="active"><a href="/admin">后台管理</a></li>
        <li><a href="/logout">退出</a></li>
      </ul>
    </div>
  </nav>
  <div class="container-fluid" style="margin-top:32px;">
    <div class="row">
      <!-- 左侧菜单 -->
      <div class="col-sm-3 col-md-2 sidebar">
        <ul class="nav nav-pills nav-stacked" id="myTab">
          <li class="active"><a href="#list" data-toggle="tab">我的文章</a></li>
          <li><a href="#new" data-toggle="tab">新建文章</a></li>
          <li><a href="#setting" data-toggle="tab">设置</a></li>
          <li><a href="#publish" data-toggle="tab">发布/导入导出</a></li>
        </ul>
      </div>
      <!-- 右侧内容区 -->
      <div class="col-sm-9 col-md-10 main-panel tab-content">
        <!-- 文章列表 -->
        <div class="tab-pane fade in active" id="list">
          <div class="panel-title">文章管理</div>
          <div class="import-export-btns">
            <button class="btn btn-primary" id="btnAddNew">+ 新建文章</button>
            <button class="btn btn-default" id="btnExport">导出JSON</button>
            <button class="btn btn-default" id="btnExportSitemap">导出sitemap.xml</button>
            <button class="btn btn-default" id="btnExportSearch">导出search.xml</button>
            <button class="btn btn-default" id="btnImport">导入JSON</button>
            <input type="file" id="importFile" style="display:none;">
          </div>
          <table class="table table-hover" style="margin-top:18px;">
            <thead>
              <tr>
                <th>标题</th>
                <th>分类</th>
                <th>标签</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="articleList">
              <!-- 文章列表由 JS 渲染 -->
            </tbody>
          </table>
          <nav>
            <ul class="pagination" id="pagination"></ul>
          </nav>
        </div>
        <!-- 新建文章 -->
        <div class="tab-pane fade" id="new">
          <div class="panel-title">新建文章</div>
          <form id="addNewForm">
            <div class="form-group">
              <label>标题</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="form-group">
              <label>分类（用逗号分隔）</label>
              <input type="text" class="form-control" name="category" required>
            </div>
            <div class="form-group">
              <label>标签（用逗号分隔）</label>
              <input type="text" class="form-control" name="tags">
            </div>
            <div class="form-group">
              <label>封面图片URL</label>
              <input type="text" class="form-control" name="img">
            </div>
            <div class="form-group">
              <label>永久链接</label>
              <input type="text" class="form-control" name="link">
            </div>
            <div class="form-group">
              <label>内容（Markdown）</label>
              <textarea class="form-control" name="content-markdown-doc" rows="8" required></textarea>
            </div>
            <div class="form-group">
              <label>内容（HTML）</label>
              <textarea class="form-control" name="content-html-code" rows="8" required></textarea>
            </div>
            <div class="form-group">
              <label>发布日期</label>
              <input type="datetime-local" class="form-control" name="createDate" required>
            </div>
            <div class="form-group">
              <label>权重</label>
              <input type="text" class="form-control" name="priority" value="0.5">
            </div>
            <div class="form-group">
              <label>更新频率</label>
              <input type="text" class="form-control" name="changefreq" value="daily">
            </div>
            <div class="form-group">
              <label>置顶</label>
              <select class="form-control" name="top_timestamp">
                <option value="0" selected>否</option>
                <option value="1">是</option>
              </select>
            </div>
            <div class="form-group">
              <label>隐藏</label>
              <select class="form-control" name="hidden">
                <option value="0" selected>否</option>
                <option value="1">是</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">发布</button>
          </form>
        </div>
        <!-- 设置 -->
        <div class="tab-pane fade" id="setting">
          <div class="panel-title">设置</div>
          <div class="setting-section">
            <h4>分类管理</h4>
            <ul class="cat-list" id="catList"></ul>
            <input type="text" class="form-control" id="newCat" placeholder="新分类名">
            <button class="btn btn-primary" id="addCat">添加分类</button>
          </div>
          <div class="setting-section">
            <h4>菜单管理</h4>
            <ul class="menu-list" id="menuList"></ul>
            <input type="text" class="form-control" id="newMenu" placeholder="新菜单名">
            <button class="btn btn-primary" id="addMenu">添加菜单</button>
          </div>
          <div class="setting-section">
            <h4>链接管理</h4>
            <ul class="link-list" id="linkList"></ul>
            <input type="text" class="form-control" id="newLink" placeholder="新链接名">
            <button class="btn btn-primary" id="addLink">添加链接</button>
          </div>
          <div class="setting-section">
            <h4>标签管理</h4>
            <ul class="tag-list" id="tagList"></ul>
            <input type="text" class="form-control" id="newTag" placeholder="新标签名">
            <button class="btn btn-primary" id="addTag">添加标签</button>
          </div>
        </div>
        <!-- 发布/导入导出 -->
        <div class="tab-pane fade" id="publish">
          <div class="panel-title">发布/导入导出</div>
          <div class="publish-section">
            <button class="btn btn-primary" id="btnPublish">发布所有文章（整理标签并清理缓存）</button>
          </div>
          <div class="publish-section">
            <button class="btn btn-default" id="btnExport2">导出JSON</button>
            <button class="btn btn-default" id="btnExportSitemap2">导出sitemap.xml</button>
            <button class="btn btn-default" id="btnExportSearch2">导出search.xml</button>
            <button class="btn btn-default" id="btnImport2">导入JSON</button>
            <input type="file" id="importFile2" style="display:none;">
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 文章管理脚本（核心功能） -->
  <script>
    // 文章分页与渲染
    function loadArticleList(page=1) {
      $.get('/admin/getList/'+page, function(data){
        let list = typeof data === 'string' ? JSON.parse(data) : data;
        let html = '';
        for(let i=0;i<list.length;i++){
          html += '<tr>';
          html += '<td><a href="/admin/edit/'+list[i].id+'" target="_blank">'+list[i].title+'</a></td>';
          html += '<td>'+(list[i].category && list[i].category[0] ? list[i].category[0] : '')+'</td>';
          html += '<td>'+(list[i].tags ? list[i].tags.join(' ') : '')+'</td>';
          html += '<td>'+list[i].createDate10+'</td>';
          html += '<td><a href="/admin/edit/'+list[i].id+'" target="_blank" style="color:#007aff;">编辑</a> <a href="#" class="delete-article" data-id="'+list[i].id+'" style="color:#d93026;margin-left:10px;">删除</a></td>';
          html += '</tr>';
        }
        $('#articleList').html(html);
      });
    }
    // 删除文章
    $(document).on('click', '.delete-article', function(e){
      e.preventDefault();
      let id = $(this).data('id');
      if(confirm('确定要删除这篇文章吗？此操作不可恢复！')){
        $.get('/admin/delete/'+id, function(res){
          let data = typeof res === 'string' ? JSON.parse(res) : res;
          if(data.status === 'success'){
            alert('删除成功');
            loadArticleList();
          }else{
            alert('删除失败：'+(data.message||'未知错误'));
          }
        });
      }
    });
    // 新建文章按钮
    $('#btnAddNew').click(function(){
      $('#myTab a[href="#new"]').tab('show');
    });
    // 新建文章表单提交
    $('#addNewForm').submit(function(e){
      e.preventDefault();
      let formData = $(this).serializeArray();
      $.ajax({
        url: '/admin/saveAddNew',
        type: 'POST',
        data: formData,
        success: function(res){
          let data = typeof res === 'string' ? JSON.parse(res) : res;
          if(data.rst){
            alert('发布成功');
            $('#myTab a[href="#list"]').tab('show');
            loadArticleList();
          }else{
            alert('发布失败：'+(data.msg||'未知错误'));
          }
        }
      });
    });
    // 导出JSON
    $('#btnExport,#btnExport2').click(function(){
      window.open('/admin/export');
    });
    // 导出sitemap.xml
    $('#btnExportSitemap,#btnExportSitemap2').click(function(){
      window.open('/admin/sitemap.xml');
    });
    // 导出search.xml
    $('#btnExportSearch,#btnExportSearch2').click(function(){
      window.open('/admin/search.xml');
    });
    // 导入JSON
    $('#btnImport,#btnImport2').click(function(){
      $(this).next('input[type=file]').click();
    });
    $('#importFile,#importFile2').change(function(e){
      let file = e.target.files[0];
      if(!file) return;
      let reader = new FileReader();
      reader.onload = function(evt){
        let content = evt.target.result;
        $.ajax({
          url: '/admin/import',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify([{name:'importJson', value: content}]),
          success: function(res){
            alert('导入成功');
            loadArticleList();
          },
          error: function(){
            alert('导入失败');
          }
        });
      };
      reader.readAsText(file);
    });
    // 设置页：分类、菜单、链接、标签管理（示例，需后端接口支持）
    function loadSetting() {
      // 分类
      $.get('/admin/getCategory', function(data){
        let list = typeof data === 'string' ? JSON.parse(data) : data;
        let html = '';
        for(let i=0;i<list.length;i++){
          html += '<li>'+list[i]+'</li>';
        }
        $('#catList').html(html);
      });
      // 菜单
      $.get('/admin/getMenu', function(data){
        let list = typeof data === 'string' ? JSON.parse(data) : data;
        let html = '';
        for(let i=0;i<list.length;i++){
          html += '<li>'+list[i]+'</li>';
        }
        $('#menuList').html(html);
      });
      // 链接
      $.get('/admin/getLink', function(data){
        let list = typeof data === 'string' ? JSON.parse(data) : data;
        let html = '';
        for(let i=0;i<list.length;i++){
          html += '<li>'+list[i]+'</li>';
        }
        $('#linkList').html(html);
      });
      // 标签
      $.get('/admin/getTags', function(data){
        let list = typeof data === 'string' ? JSON.parse(data) : data;
        let html = '';
        for(let i=0;i<list.length;i++){
          html += '<li>'+list[i]+'</li>';
        }
        $('#tagList').html(html);
      });
    }
    $('#addCat').click(function(){
      let val = $('#newCat').val().trim();
      if(val) alert('请实现分类添加接口');
    });
    $('#addMenu').click(function(){
      let val = $('#newMenu').val().trim();
      if(val) alert('请实现菜单添加接口');
    });
    $('#addLink').click(function(){
      let val = $('#newLink').val().trim();
      if(val) alert('请实现链接添加接口');
    });
    $('#addTag').click(function(){
      let val = $('#newTag').val().trim();
      if(val) alert('请实现标签添加接口');
    });
    // 发布所有文章
    $('#btnPublish').click(function(){
      $.get('/admin/publish', function(res){
        let data = typeof res === 'string' ? JSON.parse(res) : res;
        alert(data.msg || '已发布');
      });
    });
    // Tab切换时刷新
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      if($(e.target).attr('href')==='#list'){
        loadArticleList();
      }
      if($(e.target).attr('href')==='#setting'){
        loadSetting();
      }
    });
    // 页面加载时加载文章列表
    $(function(){
      loadArticleList();
    });
  </script>
</body>
</html>
